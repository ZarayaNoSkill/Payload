<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>LoRaWAN Payload Helper</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0 }
    html, body { height:100%; font-family:'Segoe UI',sans-serif; background:#f0f2f5; color:#333 }
    h1 { text-align:center; margin:1rem 0; color:#444 }

    .container {
      max-width:900px; margin:0 auto; padding:1rem;
      display:grid; gap:1.5rem;
    }
    @media(min-width:800px) {
      .container { grid-template-columns:1fr 1fr }
    }

    .card {
      background:#fff; border-radius:8px; padding:1.5rem;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
    }

    label { display:block; margin-bottom:.5rem; font-weight:600 }
    select, input, textarea {
      width:100%; padding:.6rem; margin-bottom:1rem;
      border:1px solid #ccc; border-radius:4px; font-size:1rem;
    }
    textarea { resize:vertical; height:80px }

    button {
      padding:.7rem 1.2rem; background:#007bff; color:#fff;
      border:none; border-radius:4px; cursor:pointer;
      transition:background .2s; font-size:1rem;
    }
    button:hover { background:#0056b3 }

    .output {
      position:relative; background:#272822; color:#f8f8f2;
      border-radius:4px; padding:2rem; min-height:120px;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      text-align:center; font-family:monospace; font-size:1.1rem;
      margin-top:1rem;
    }
    .output-text { width:100% }
    .copy-btn {
      position:absolute; top:.5rem; right:.5rem;
      background:#28a745; color:#fff; border:none;
      padding:.3rem .6rem; border-radius:3px; font-size:.75rem;
      cursor:pointer;
    }
    .copy-btn:hover { background:#1e7e34 }
  </style>
</head>
<body>

  <h1>LoRaWAN Payload Helper</h1>
  <div class="container">

    <!-- Décodage Uplink -->
    <div class="card">
      <h2>Décodage Uplink</h2>
      <label for="uplinkDevice">Équipement :</label>
      <select id="uplinkDevice">
        <option value="mclimate">MClimate Thermostat</option>
        <option value="thx">ATIM THx</option>
      </select>
      <label for="hexInput">Payload hexadécimal :</label>
      <textarea id="hexInput" placeholder="e.g. 1A2B3C"></textarea>
      <button id="decodeBtn">Décoder</button>
      <pre id="decodeOutput" class="output"></pre>
    </div>

    <!-- Encodage Downlink -->
    <div class="card">
      <h2>Encodage Downlink</h2>
      <label for="deviceSelect">Équipement :</label>
      <select id="deviceSelect">
        <option value="mclimate">MClimate Thermostat</option>
        <option value="thx">ATIM THx</option>
      </select>

      <label for="commandSelect">Commande :</label>
      <select id="commandSelect"></select>
      <div id="paramsContainer"></div>
      <button id="encodeBtn">Générer Payload</button>
      <div id="encodeOutput"></div>
    </div>

  </div>

  <script>
    // listes de commandes
    const commands = {
      mclimate: [
        {cat:"set",code:"setTargetTemperature",label:"Set Target Temperature",fields:[{name:"Temperature (°C)",key:"setTargetTemperature",type:"number"}]},
        /* ... toutes les autres ... */,
        {cat:"other",code:"restartDevice",label:"Restart Device"},
        {cat:"other",code:"sendCustomHexCommand",label:"Send Custom HEX",fields:[{name:"HEX Payload",key:"sendCustomHexCommand",type:"text"}]},
      ],
      thx: [
        {cat:"other",code:"restart",label:"Restart"},
        {cat:"other",code:"about",label:"About"},
        {cat:"other",code:"reset",label:"Reset"},
        {cat:"other",code:"getConfig",label:"Get Config"}
      ]
    };

    // fonctions de décodage
    function DecodeMClimate(bytes){
      // ici incruster ta fonction Decode(port,bytes)
      return {info:"Décodage MClimate mock",raw:bytes};
    }
    function decodeThx(bytes){
      let o={};
      for(let i=0;i<bytes.length;){
        let c=bytes[i++];
        if(c===0x81){o.battery=bytes[i++]/10}
        else if(c===0x08){o.temp=bytes[i++]/2}
        else if(c===0x09){o.humidity=bytes[i++]/2}
        else break;
      }
      return o;
    }

    // encodeurs
    function encodeMClimate(cmd,params){
      let b=[/* ... ton switch complet ... */];
      return b;
    }
    function encodeThx(cmd){
      const m={restart:1,about:2,reset:3,getConfig:4};
      return [1,m[cmd]];
    }

    // INIT Décodage
    document.getElementById("decodeBtn").onclick=()=>{
      const dev=document.getElementById("uplinkDevice").value;
      const hex=document.getElementById("hexInput").value.trim();
      if(!hex.match(/^[0-9A-Fa-f]+$/)){ alert("Hex invalide"); return; }
      const bytes=hex.match(/.{1,2}/g).map(h=>parseInt(h,16));
      let res = dev==="thx" ? decodeThx(bytes) : DecodeMClimate(bytes);
      document.getElementById("decodeOutput").textContent=JSON.stringify(res,null,2);
    };

    // INIT Encodage
    function fillCommands(){
      const dev=document.getElementById("deviceSelect").value;
      const sel=document.getElementById("commandSelect");
      sel.innerHTML="";
      ["set","get","other"].forEach(cat=>{
        let g=document.createElement("optgroup"); g.label=cat.toUpperCase()+" Commands";
        commands[dev].filter(c=>c.cat===cat).forEach(c=>{
          let o=document.createElement("option");
          o.value=c.code; o.textContent=c.label;
          g.appendChild(o);
        });
        sel.appendChild(g);
      });
      updateParams();
    }
    function updateParams(){
      const dev=document.getElementById("deviceSelect").value;
      const cmd=document.getElementById("commandSelect").value;
      const cont=document.getElementById("paramsContainer");
      cont.innerHTML="";
      let e=commands[dev].find(c=>c.code===cmd);
      if(e&&e.fields) e.fields.forEach(f=>{
        let l=document.createElement("label"); l.textContent=f.name;
        let i=document.createElement("input"); i.type=f.type; i.dataset.key=f.key;
        cont.appendChild(l); cont.appendChild(i);
      });
    }
    document.getElementById("deviceSelect").onchange=fillCommands;
    document.getElementById("commandSelect").onchange=updateParams;
    fillCommands();

    document.getElementById("encodeBtn").onclick=()=>{
      const dev=document.getElementById("deviceSelect").value;
      const cmd=document.getElementById("commandSelect").value;
      let params={}, ok=true;
      document.querySelectorAll("#paramsContainer input").forEach(i=>{
        if(!i.value){ ok=false }
        params[i.dataset.key]=i.value;
      });
      if(!ok){ alert("Tous les champs doivent être remplis."); return; }
      let bytes = dev==="thx" ? encodeThx(cmd) : encodeMClimate(cmd,params);
      let hex=bytes.map(b=>b.toString(16).padStart(2,"0")).join("").toUpperCase();
      let b64=btoa(String.fromCharCode(...bytes)).toUpperCase();
      document.getElementById("encodeOutput").innerHTML=`
        <div class="output">
          <button class="copy-btn" data-copy="hex">Copier HEX</button>
          <div class="output-text">HEX: ${hex}</div>
        </div>
        <div class="output">
          <button class="copy-btn" data-copy="base64">Copier BASE64</button>
          <div class="output-text">BASE64: ${b64}</div>
        </div>`;
      document.querySelectorAll('.copy-btn').forEach(btn=>{
        btn.onclick=()=>{
          let txt=(btn.dataset.copy==="hex"?hex:b64);
          navigator.clipboard.writeText(txt);
          btn.textContent="Copié !";
          setTimeout(()=> btn.textContent=`Copier ${btn.dataset.copy.toUpperCase()}`,1500);
        };
      });
    };
  </script>
</body>
</html>
